<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Slide Editor</title>

    <!-- Bootstrap Core CSS -->
    <link href="../bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- MetisMenu CSS -->
    <link href="../bower_components/metisMenu/dist/metisMenu.min.css" rel="stylesheet">

    <!-- Timeline CSS -->
    <link href="../dist/css/timeline.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="../dist/css/sb-admin-2.css" rel="stylesheet">

    <!-- Morris Charts CSS -->
    <link href="../bower_components/morrisjs/morris.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="../bower_components/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>

    <div id="wrapper">

        <!-- Navigation -->
        <nav class="navbar navbar-default navbar-static-top" role="navigation" style="margin-bottom: 0">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="index.html">Slide Editor</a>
            </div>
            <!-- /.navbar-header -->

            <div class="navbar-default sidebar" role="navigation">
                <div class="sidebar-nav navbar-collapse">
                    <div class="list-group" id="side-menu">

                      <button class="list-group-item"><i class="fa fa-font fa-w"></i> Add Text</button>
                      <button class="list-group-item"><i class="fa fa-circle fa-fw"></i>Add Floating Text</button>
                      <span class="list-group-item">
                           <i class="fa fa-image fa-w"></i> Add Picture
                           <input id="imageLoader" name="imageLoader" type="file"></input>
                     </span>
                     <button id="upload" class="list-group-item"><i class="fa fa-upload fa-w"></i> Upload</button>


                    </ul>
                </div>
                <!-- /.sidebar-collapse -->
            </div>
            <!-- /.navbar-static-side -->
        </nav>



    </div>
    <!-- /#wrapper -->
    <div id="page-wrapper">
          <div id="main">
             <canvas id="c" class="img-responsive" style="border:2px solid black;" width="700" height="500"></canvas>
          </div>

          <script>
             var imageLoader = document.getElementById('imageLoader');
             imageLoader.addEventListener('change', handleImage, false);
             var canvas = document.getElementById('c');
             var ctx = canvas.getContext('2d');


             function handleImage(e){
                  var reader = new FileReader();
                  reader.onload = function(event){
                     var img = new Image();
                     img.onload = function(){
                          canvas.width = img.width;
                          canvas.height = img.height;
                          ctx.drawImage(img,0,0);
                     }
                     img.src = event.target.result;
                  }
                  reader.readAsDataURL(e.target.files[0]);
             }
          </script>
          <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
          <script type="text/javascript" src="text.js"></script><!-- Library to help text -->
          <script type="text/javascript">
          function init() {
             var button = document.getElementById('upload');
             var canvas = document.getElementById('c');
             var ctx = canvas.getContext('2d');
             drawDemo(ctx);
             initUpload(canvas, button);
          }
          function initUpload(canvas, button) {
             button.onclick = function() {
                  var xhr = new XMLHttpRequest();
                  var formData = new FormData();
                  var dataURI = canvas.toDataURL();
                  var blob = dataURItoBlob(dataURI);
                  formData.append('upload.png', blob);
                  xhr.open('POST', '/upload', true);
                  xhr.onload = function(e) {
                     console.log('success');
                  };
                  xhr.send(formData);
             }
          }
          function dataURItoBlob(dataURI) {
             // convert base64 to raw binary data held in a string
             // doesn't handle URLEncoded DataURIs - see SO answer #6850276 for code that does this
             var byteString = atob(dataURI.split(',')[1]);
             // separate out the mime component
             var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
             // write the bytes of the string to an ArrayBuffer
             var ab = new ArrayBuffer(byteString.length);
             var dw = new DataView(ab);
             for(var i = 0; i < byteString.length; i++) {
                  dw.setUint8(i, byteString.charCodeAt(i));
             }
             // write the ArrayBuffer to a blob, and you're done
             return new Blob([ab], {type: mimeString});
          }
          </script>
             <script type="text/javascript">
                  $('#c').mousedown(function(e){
                     if ($('#textAreaPopUp').length == 0) {
                          var mouseX = e.pageX - this.offsetLeft + $("#c").position().left;
                          var mouseY = e.pageY - this.offsetTop;
                          //append a text area box to the canvas where the user clicked to enter in a comment
                          var textArea = "<div id='textAreaPopUp' style='position:absolute;top:"+mouseY+"px;left:"+mouseX+"px;z-index:30;'><textarea id='textareaTest' style='width:100px;height:50px;'></textarea>";
                          var saveButton = "<input type='button' value='save' id='saveText' onclick='saveTextFromArea("+mouseY+","+mouseX+");'></div>";
                          var appendString = textArea + saveButton;
                          $("#main").append(appendString);
                     } else {
                          $('textarea#textareaTest').remove();
                          $('#saveText').remove();
                          $('#textAreaPopUp').remove();
                          var mouseX = e.pageX - this.offsetLeft + $("#c").position().left;
                          var mouseY = e.pageY - this.offsetTop;
                          //append a text area box to the canvas where the user clicked to enter in a comment
                          var textArea = "<div id='textAreaPopUp' style='position:absolute;top:"+mouseY+"px;left:"+mouseX+"px;z-index:30;'><textarea id='textareaTest' style='width:100px;height:50px;'></textarea>";
                          var saveButton = "<input type='button' value='save' id='saveText' onclick='saveTextFromArea("+mouseY+","+mouseX+");'></div>";
                          var appendString = textArea + saveButton;
                          $("#main").append(appendString);
                     }
                  });

                  function saveTextFromArea(y,x){
                     //get the value of the textarea then destroy it and the save button
                     var text = $('textarea#textareaTest').val();
                     $('textarea#textareaTest').remove();
                     $('#saveText').remove();
                     $('#textAreaPopUp').remove();
                     //get the canvas and add the text functions
                     var canvas = document.getElementById('c');
                     var ctx = canvas.getContext('2d');
                     var cw = canvas.clientWidth;
                     var ch = canvas.clientHeight;
                     canvas.width = cw;
                     canvas.height = ch;
                     //break the text into arrays based on a text width of 100px
                     var phraseArray = getLines(ctx,text,100);
                     // this adds the text functions to the ctx
                     CanvasTextFunctions.enable(ctx);
                     var counter = 0;
                     //set the font styles
                     var font = "sans";
                     var fontsize = 16;
                     ctx.strokeStyle = "rgba(237,229,0,1)";
                     ctx.shadowOffsetX = 2;
                     ctx.shadowOffsetY = 2;
                     ctx.shadowBlur = 1;
                     ctx.shadowColor = "rgba(0,0,0,1)";
                     //draw each phrase to the screen, making the top position 20px more each time so it appears there are line breaks
                     $.each(phraseArray, function() {
                          //set the placement in the canvas
                          var lineheight = fontsize * 1.5;
                          var newline = ++counter;
                          newline = newline * lineheight;
                          var topPlacement = y - $("#c").position().top + newline;
                          var leftPlacement = x - $("#c").position().left;
                          text = this;
                          //draw the text
                          ctx.drawText(font, fontsize, leftPlacement, topPlacement, text);
                          ctx.save();
                          ctx.restore();
                     });
                     //reset the drop shadow so any other drawing don't have them
                     ctx.shadowOffsetX = 0;
                     ctx.shadowOffsetY = 0;
                     ctx.shadowBlur = 0;
                     ctx.shadowColor = "rgba(0,0,0,0)";
                  }

                  function getLines(ctx,phrase,maxPxLength) {
                     //break the text area text into lines based on "box" width
                     var wa=phrase.split(" "),
                     phraseArray=[],
                     lastPhrase="",
                     l=maxPxLength,
                     measure=0;
                     ctx.font = "16px sans-serif";
                     for (var i=0;i<wa.length;i++) {
                          var w=wa[i];
                          measure=ctx.measureText(lastPhrase+w).width;
                          if (measure<l) {
                              lastPhrase+=(" "+w);
                          }else {
                              phraseArray.push(lastPhrase);
                              lastPhrase=w;
                          }
                          if (i===wa.length-1) {
                              phraseArray.push(lastPhrase);
                              break;
                          }
                     }
                     return phraseArray;
                  }
             </script>
      </div>
    <!-- jQuery -->
    <script src="../bower_components/jquery/dist/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="../bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

    <!-- Metis Menu Plugin JavaScript -->
    <script src="../bower_components/metisMenu/dist/metisMenu.min.js"></script>

    <!-- Morris Charts JavaScript -->
    <script src="../bower_components/raphael/raphael-min.js"></script>
    <script src="../bower_components/morrisjs/morris.min.js"></script>
    <script src="../js/morris-data.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="../dist/js/sb-admin-2.js"></script>

</body>

</html>
